<!DOCTYPE html>
<html>
  <head>
    <title>Mandlebrot</title>
    <style type="text/css">
#mandelbrot-size {
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
}
    </style>
  </head>
  <body>

    <div id="mandelbrot-size">
      <canvas id="mandelbrot"></canvas>
    </div>
    <script>

function Mandelbrot(stdlib, foreign, heap) {
    "use asm";

   var heapb = new stdlib.Uint8Array(heap);

    function member(cr, ci) {
        cr = +cr;
        ci = +ci;

        var ar = 0.0, ai=0.0, r=0.0, i=0.0, iter=0, max=100;

        ar = cr, ai=ci;
        for (iter=0;
             (iter>>0 < max>>0) &
             ((ar < 10.0) | (ar > 1.0)) &
             ((ai < 10.0) | (ai > 1.0));
             // ((+stdlib.Math.abs(ar)) < 10.0) &
             // ((+stdlib.Math.abs(ai)) < 10.0);
             iter = (iter>>0) + 1>>0) {
            r=ar, i=ai;
            ar = r*r - i*i + cr;
            ai = 2.0*r*i + ci;
        }
        return +((+(iter>>0))/(+(max>>0)));
    }

    function line(crs, cis, inc, n) {
        crs = +crs;
        cis = +cis;
        inc = +inc;
        n = n|0;

        var cr=0.0, ci=0.0, i=0, memb=0;
        cr = crs;
        ci = cis;
        for (i=0; i>>0 < n>>0; i = (i>>0) + 1>>0) {
            memb = ~~(+member(cr,ci) * 255.0);
            heapb[((i<<2)+0)>>0] = 255-memb; // r
            heapb[((i<<2)+1)>>0] = memb; // g
            heapb[((i<<2)+2)>>0] = memb; // b
            heapb[((i<<2)+3)>>0] = 255;  // a

            cr = +cr + +inc;
        }
    }

    return { member: member, line: line };
}


function Mandel(canvas_el) {
    this.el = canvas_el;
    this.context = this.el.getContext('2d');
    this.zoom(0,0,.8);
}
Mandel.prototype.resize = function(max_x, max_y) {
    this.size = Math.min(Math.floor(max_x/3),
                         Math.floor(max_y/2));
    this.el.width  = this.size*3;
    this.el.height = this.size*2;
    this.linebuffer = this.context.getImageData(0, 0, this.el.width, 1);
    this.linebuf8 = new ArrayBuffer((this.linebuffer.data.length + 4095) & ~4095);
    this.fast = Mandelbrot(window, {}, this.linebuf8);
}
Mandel.prototype.zoom = function(center_x, center_y, zoom) {
    this.r = { min: (center_x - 2) / zoom,
               max: (center_x + 1) / zoom };
    this.r.span = this.r.max - this.r.min;

    this.i = { min: (center_y - 1) / zoom,
               max: (center_y + 1) / zoom };
    this.i.span = this.i.max - this.i.min;
}


Mandel.prototype.line = function(y) {
    this.fast.line(this.r.min,
                   y/this.el.height * this.i.span + this.i.min,
                   this.r.span / this.el.width,
                   this.el.width);
    this.linebuffer.data.set(new Uint8Array(this.linebuf8, 0, this.linebuffer.data.length));
    this.context.putImageData(this.linebuffer, 0, y);
}

Mandel.prototype.draw = function() {
    if (this.drawer)
        clearTimeout(this.drawer);
    this.start = Date.now();
    var y = 0;
    var me = this;
    var iter = function() {
        var start = Date.now();
        do {
            me.line(y);
            y++;
        } while (y < me.el.height && Date.now() - start < 100);
        if (y < me.el.height)
            me.drawer = setTimeout(iter, 0);
        else
            console.log(Date.now() - me.start);
    }
    iter();
}

var mandel = new Mandel(document.getElementById("mandelbrot"));
window.onresize = function() {
    var sizer = document.getElementById("mandelbrot-size");
    mandel.resize(sizer.clientWidth,
                  sizer.clientHeight);
    mandel.draw();
}
window.onresize();

    </script>

  <address>
    <a href="mailto:david@porkrind.org">David Caldwell</a>
  </address>
  </body>
</html>