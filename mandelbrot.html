<!DOCTYPE html>
<html>
  <head>
    <title>Mandlebrot</title>
    <style type="text/css">
#mandelbrot-size {
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
}
    </style>
  </head>
  <body>

    <div id="mandelbrot-size">
      <canvas id="mandelbrot"></canvas>
    </div>
    <script>

function Mandelbrot(stdlib, foreign, heap) {
    "use asm";

    function member(cr, ci) {
        cr = +cr;
        ci = +ci;

        var ar = 0.0, ai=0.0, r=0.0, i=0.0, iter=0, max=100;

        ar = cr, ai=ci;
        for (iter=0;
             (iter>>0 < max>>0) &
             ((ar < 10.0) | (ar > 1.0)) &
             ((ai < 10.0) | (ai > 1.0));
             // ((+stdlib.Math.abs(ar)) < 10.0) &
             // ((+stdlib.Math.abs(ai)) < 10.0);
             iter = (iter>>0) + 1>>0) {
            r=ar, i=ai;
            ar = r*r - i*i + cr;
            ai = 2.0*r*i + ci;
        }
        return +((+(iter>>0))/(+(max>>0)));
    }

    return { member: member };
}


function complex(r,i) { this.r=r; this.i=i; }
complex.prototype.add    = function(c) { this.r += c.r; this.i += c.i; return this; };
complex.prototype.square = function()  { var r=this.r, i=this.i; this.r = r*r - i*i; this.i = 2*r*i; return this; };

function Mandel(canvas_el) {
    this.el = canvas_el;
    this.context = this.el.getContext('2d');
    this.zoom(0,0,.8);
}
Mandel.prototype.resize = function(max_x, max_y) {
    this.size = Math.min(Math.floor(max_x/3),
                         Math.floor(max_y/2));
    this.el.width  = this.size*3;
    this.el.height = this.size*2;
    this.linebuffer = this.context.getImageData(0, 0, this.el.width, 1);
    this.fast = Mandelbrot(window, {}, []);
}
Mandel.prototype.zoom = function(center_x, center_y, zoom) {
    this.r = { min: (center_x - 2) / zoom,
               max: (center_x + 1) / zoom };
    this.r.span = this.r.max - this.r.min;

    this.i = { min: (center_y - 1) / zoom,
               max: (center_y + 1) / zoom };
    this.i.span = this.i.max - this.i.min;
}

Mandel.prototype.member = function(c) {
    return this.fast.member(c.r,c.i);
}

Mandel.prototype.pixel = function(x,y) {
    var member = this.member(new complex(x/this.el.width  * this.r.span + this.r.min,
                                         y/this.el.height * this.i.span + this.i.min));

    member = 1 - member;
    return { r:member, g:member, b:member, a:1 };
}

Mandel.prototype.line = function(y) {
    for (var x=0, i=0; x<this.el.width; x++) {
        var c = this.pixel(x,y);
        this.linebuffer.data[i++] = Math.floor(c.r*255);
        this.linebuffer.data[i++] = Math.floor(255-c.g*255);
        this.linebuffer.data[i++] = Math.floor(c.b*255);
        this.linebuffer.data[i++] = Math.floor(c.a*255);
    }
    this.context.putImageData(this.linebuffer, 0, y);
}

Mandel.prototype.draw = function() {
    if (this.drawer)
        clearTimeout(this.drawer);
    this.start = Date.now();
    var y = 0;
    var me = this;
    var iter = function() {
        var start = Date.now();
        do {
            me.line(y);
            y++;
        } while (y < me.el.height && Date.now() - start < 100);
        if (y < me.el.height)
            me.drawer = setTimeout(iter, 0);
        else
            console.log(Date.now() - me.start);
    }
    iter();
}

var mandel = new Mandel(document.getElementById("mandelbrot"));
window.onresize = function() {
    var sizer = document.getElementById("mandelbrot-size");
    mandel.resize(sizer.clientWidth,
                  sizer.clientHeight);
    mandel.draw();
}
window.onresize();

    </script>

  <address>
    <a href="mailto:david@porkrind.org">David Caldwell</a>
  </address>
  </body>
</html>